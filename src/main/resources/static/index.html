<!DOCTYPE html>
<html>
<head>
    <title>Crypto Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; display: flex; gap: 20px; padding: 20px; background: #f0f2f5; }
        .box { background: white; width: 50%; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        #ticker { font-size: 2.5em; font-weight: bold; color: #27ae60; margin-top: 20px; }
        #chat-box { height: 300px; overflow-y: scroll; border: 1px solid #eee; padding: 10px; margin-bottom: 10px; }
        .msg { margin-bottom: 5px; }
        .msg b { color: #2980b9; }
    </style>
</head>
<body>

<div class="box">
    <h2>ðŸ“ˆ Live Market (SSE + Kafka)</h2>
    <div id="ticker">Loading...</div>
    <p>Updates via Server-Sent Events from Kafka Stream</p>
</div>

<div class="box">
    <h2>ðŸ’¬ Global Chat (WS + Redis + MySQL)</h2>
    <div id="chat-box"></div>
    <input type="text" id="username" placeholder="User" style="width: 20%">
    <input type="text" id="input" placeholder="Message" style="width: 60%">
    <button onclick="send()">Send</button>
</div>

<script>
    // 1. SSE
    new EventSource('/stream').addEventListener('market-tick', e => {
        const data = JSON.parse(e.data);
        document.getElementById('ticker').innerText = `${data.symbol}: $${data.price.toFixed(2)}`;
    });

    // 2. Chat
    const socket = new SockJS('/ws-endpoint');
    const stomp = Stomp.over(socket);

    // Load history
    fetch('/api/chat/history').then(r => r.json()).then(msgs => {
        msgs.reverse().forEach(addMsg);
    });

    stomp.connect({}, () => {
        stomp.subscribe('/topic/chat', msg => addMsg(JSON.parse(msg.body)));
    });

    function send() {
        const user = document.getElementById('username').value || 'Anon';
        const content = document.getElementById('input').value;
        if(content) {
            stomp.send("/app/send-message", {}, JSON.stringify({sender: user, content: content}));
            document.getElementById('input').value = '';
        }
    }

    function addMsg(msg) {
        const div = document.getElementById('chat-box');
        div.innerHTML += `<div class="msg"><b>${msg.sender}:</b> ${msg.content}</div>`;
        div.scrollTop = div.scrollHeight;
    }
</script>

</body>
</html>